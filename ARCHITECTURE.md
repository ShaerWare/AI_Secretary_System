# Архитектура AI Secretary System

## Обзор компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                    AI SECRETARY SYSTEM                      │
│                    (Voice-TTS Project)                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────┐
│  Телефонные │
│   звонки    │  ← Twilio / SIP
└──────┬──────┘
       │
       v
┌──────────────────────────────────────────────────────────────┐
│              PHONE SERVICE (phone_service.py)                │
│                        Port: 8001                            │
│                                                              │
│  - Прием входящих звонков через Twilio                       │
│  - Запись речи абонента                                      │
│  - TwiML генерация для управления звонком                    │
│  - Отправка аудио на обработку в Orchestrator               │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       v
┌──────────────────────────────────────────────────────────────┐
│            ORCHESTRATOR (orchestrator.py)                    │
│                     Port: 8000                               │
│                                                              │
│  Главный координатор всех сервисов                          │
│  FastAPI сервер с endpoints:                                │
│    - /process_call - полный цикл обработки                  │
│    - /tts - только синтез речи                              │
│    - /stt - только распознавание                            │
│    - /chat - только LLM                                     │
│    - /health - проверка здоровья                            │
│                                                              │
│  Логика:                                                    │
│    1. Получает аудио                                        │
│    2. Вызывает STT Service                                  │
│    3. Отправляет текст в LLM Service                        │
│    4. Синтезирует ответ через TTS Service                   │
│    5. Возвращает аудио ответ                                │
│    6. Логирует всё в calls_log/                             │
└────────┬──────────────┬──────────────┬───────────────────────┘
         │              │              │
         v              v              v
┌────────────────┐ ┌──────────┐ ┌─────────────────┐
│  STT SERVICE   │ │   LLM    │ │   TTS SERVICE   │
│ (stt_service)  │ │ SERVICE  │ │(voice_clone_s.) │
│                │ │(llm_svc) │ │                 │
│ Whisper /      │ │          │ │   XTTS v2       │
│ Faster-Whisper │ │  Gemini  │ │ Voice Cloning   │
│                │ │ 2.5 Pro  │ │                 │
│ Распознает     │ │          │ │  Синтезирует    │
│ речь из        │ │ Генерит  │ │  речь с         │
│ аудио в текст  │ │ ответы   │ │  голосом Лидии  │
│                │ │ секретаря│ │                 │
│ Модели:        │ │          │ │  Использует     │
│ - tiny         │ │ System   │ │  образцы из     │
│ - base  ⭐     │ │ Prompt   │ │  папки Лидия/   │
│ - small        │ │          │ │                 │
│ - medium       │ │ История  │ │  Первые 3 WAV   │
│ - large        │ │ диалога  │ │  файла          │
└────────────────┘ └──────────┘ └─────────────────┘
        │              │              │
        v              v              v
┌────────────────┐ ┌──────────┐ ┌─────────────────┐
│  GPU / CPU     │ │ Gemini   │ │   GPU / CPU     │
│  CUDA          │ │   API    │ │   CUDA          │
└────────────────┘ └──────────┘ └─────────────────┘
```

## Поток данных

### 1. Входящий звонок

```
Звонок → Twilio
         ↓
    Phone Service (/incoming_call)
         ↓
    Приветствие (TwiML)
         ↓
    Запись речи абонента
         ↓
    /handle_speech endpoint
```

### 2. Обработка звонка

```
Аудио запись
    ↓
Orchestrator (/process_call)
    ↓
┌───┴─────────────────────────────┐
│ 1. STT Service                  │
│    audio.wav → text             │
│    "Здравствуйте, это XYZ?"     │
├─────────────────────────────────┤
│ 2. LLM Service                  │
│    text → response_text         │
│    "Да, компания XYZ. Чем помочь?"│
├─────────────────────────────────┤
│ 3. TTS Service                  │
│    response_text → audio        │
│    "Да, компания..." → audio.wav│
└───┬─────────────────────────────┘
    ↓
Возврат аудио ответа
    ↓
Phone Service
    ↓
Twilio → Абоненту
```

### 3. Логирование

Каждый звонок сохраняется в `calls_log/`:

```
calls_log/
├── call_20240108_153045_input.wav      # Входящее аудио
├── call_20240108_153045_output.wav     # Ответ секретаря
└── call_20240108_153045_transcript.txt # Текстовая расшифровка
```

## Детали сервисов

### Voice Clone Service (voice_clone_service.py)

**Технология**: Coqui TTS XTTS v2

**Функции**:
- Загрузка образцов голоса из `Лидия/`
- Few-shot voice cloning (нужно всего 3+ образца)
- Синтез речи с клонированным голосом
- Поддержка русского и других языков

**Требования**:
- GPU: 8-12GB VRAM (работает на RTX 3060)
- Образцы: 3+ WAV файлов, чистая речь

**Производительность**:
- Первый запуск: ~30 секунд (загрузка модели)
- Синтез: ~2-5 секунд на предложение
- Качество: очень высокое, похоже на оригинал

### STT Service (stt_service.py)

**Технология**: Whisper / Faster-Whisper

**Модели**:
- `tiny` - самая быстрая, низкое качество
- `base` - баланс скорость/качество ⭐
- `small` - хорошее качество
- `medium` - отличное качество
- `large` - максимум качества, медленно

**Особенности**:
- VAD (Voice Activity Detection) - пропускает тишину
- Поддержка длинных аудио
- Сегментация по предложениям
- Timestamps для каждого сегмента

**Производительность**:
- base на GPU: ~0.5-1 сек на 10 сек аудио
- medium на GPU: ~1-2 сек на 10 сек аудио

### LLM Service (llm_service.py)

**Технология**: Google Gemini API

**Модели**:
- `gemini-2.5-pro-latest` - максимум качества ⭐
- `gemini-2.0-flash` - быстрая альтернатива

**Системный промпт**:
```
Ты - профессиональный виртуальный секретарь по имени Лидия.

Обязанности:
- Отвечать на звонки вежливо
- Записывать информацию
- Отвечать на типовые вопросы
...
```

**Возможности**:
- История диалога (контекст)
- Настраиваемый промпт
- Обработка русского языка
- Fallback при ошибках

### Phone Service (phone_service.py)

**Технология**: Twilio + TwiML

**Endpoints**:
- `/incoming_call` - прием звонков
- `/handle_speech` - обработка записи
- `/continue_or_end` - продолжить или завершить
- `/recording_status` - статус записи

**Логика звонка**:
1. Приветствие
2. Запись речи (макс 30 сек)
3. Отправка в Orchestrator
4. Проигрывание ответа
5. Опция продолжить диалог

## Масштабирование

### Горизонтальное

```
                    ┌─ Orchestrator 1 (GPU 1)
Load Balancer  ─────┼─ Orchestrator 2 (GPU 2)
                    └─ Orchestrator 3 (CPU)
```

### Вертикальное

- Больше GPU памяти → более крупные модели
- Больше CPU → параллельная обработка
- SSD → быстрая загрузка моделей

### Оптимизации

1. **Кэширование моделей** - держать в памяти
2. **Batch processing** - несколько запросов сразу
3. **Model quantization** - INT8/FP16
4. **Streaming TTS** - генерация по частям
5. **Connection pooling** - переиспользование соединений

## Безопасность

### API Keys
- Хранятся в `.env`
- Не попадают в git
- Доступ через переменные окружения

### Network
- HTTPS для production
- API authentication tokens
- Rate limiting
- Firewall rules

### Data
- Шифрование аудио в transit
- Автоудаление старых логов
- Анонимизация персональных данных

## Мониторинг

### Метрики
- Количество звонков
- Время обработки
- Ошибки по типам
- Использование GPU/CPU
- Использование памяти

### Логи
- Структурированное логирование
- Уровни: DEBUG, INFO, WARNING, ERROR
- Ротация логов
- Централизованный сбор (ELK, Loki)

## Deployment

### Development
```bash
./run.sh
```

### Production
```bash
docker-compose up -d
```

### CI/CD
```yaml
- Build Docker images
- Run tests
- Push to registry
- Deploy to servers
- Health checks
- Rollback if needed
```

## Расширения

### Будущие возможности
- WebRTC для браузерных звонков
- Asterisk/FreeSWITCH интеграция
- Поддержка других языков
- CRM интеграция (Битрикс24, AmoCRM)
- Календарь (Google Calendar, Outlook)
- Email отправка
- SMS уведомления
- Голосовая аналитика
- Sentiment analysis
- Автоматическая классификация звонков
